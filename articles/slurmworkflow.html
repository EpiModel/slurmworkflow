<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="slurmworkflow">
<title>slurmworkflow • slurmworkflow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="slurmworkflow">
<meta property="og:description" content="slurmworkflow">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">slurmworkflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/slurmworkflow.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>slurmworkflow</h1>
            
      
      
      <div class="d-none name"><code>slurmworkflow.Rmd</code></div>
    </div>

    
    
<p>The goal of slurmworkflow is to provide a way to run complex multi
step computations on a <a href="https://slurm.schedmd.com/" class="external-link">slurm</a>
equipped HPC.</p>
<p>Definitions:</p>
<ul>
<li>A <em>workflow</em> is a predefined set of computation steps.</li>
<li>A computation <em>step</em> is a call to <a href="https://slurm.schedmd.com/sbatch.html" class="external-link"><code>sbatch</code></a> to
be run on the HPC</li>
<li>A <em>workflow directory</em> is a directory containing all the code
required to run a full workflow on the HPC</li>
</ul>
<p>By default the steps are run sequentially. But slurmworkflow provides
tools for changing the execution order. This allows conditional
execution of the steps and loop like behavior.</p>
<p>In this vignette we walk through the creation of a 4 steps workflow
showcasing the main utilities provided by slurmworkflow.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>Any HPC using <a href="https://slurm.schedmd.com/" class="external-link">slurm</a> as its
workload manager should work with slurmworkflow.</p>
<p>HPC tested: - <a href="https://sph.emory.edu/research/labs/index.html" class="external-link">Emory’s RSPH
HPC</a> (in this vignette) - <a href="https://environment.uw.edu/intranet/technology-resources/hyak-uw-hpc-high-performance-computing-program/" class="external-link">Washington’s
HYAK HPC</a></p>
<p>We highly recommend using <a href="https://rstudio.github.io/renv/index.html" class="external-link">renv</a> when working
with an HPC.</p>
</div>
<div class="section level2">
<h2 id="creating-a-new-workflow">Creating a New Workflow<a class="anchor" aria-label="anchor" href="#creating-a-new-workflow"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://epimodel.github.io/slurmworkflow/">slurmworkflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_workflow.html">create_workflow</a></span><span class="op">(</span></span>
<span>  wf_name <span class="op">=</span> <span class="st">"test_slurmworkflow"</span>,</span>
<span>  default_sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"partition"</span> <span class="op">=</span> <span class="st">"epimodel"</span>,</span>
<span>    <span class="st">"mail-type"</span> <span class="op">=</span> <span class="st">"FAIL"</span>,</span>
<span>    <span class="st">"mail-user"</span> <span class="op">=</span> <span class="st">"user@emory.edu"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>First we create a new workflow called “test_slurmworkflow” and store
a summary of it in the <code>wf</code> object. The second argument
specifies that by default each <em>step</em> should run on the
“epimodel” partition and send a mail at “<a href="mailto:user@emory.edu" class="email">user@emory.edu</a>” if the step fails.</p>
<p>Calling <code><a href="../reference/create_workflow.html">create_workflow()</a></code> result in the creation of the
<em>workflow directory</em>: “workflows/test_slurmworkflow/” that
contains the code to send to the HPC. A <em>workflow summary</em> is
returned and stored in the <code>wf</code> variable. We’ll use it to add
elements to the workflow.</p>
</div>
<div class="section level2">
<h2 id="adding-a-step-to-the-workflow">Adding a Step to the Workflow<a class="anchor" aria-label="anchor" href="#adding-a-step-to-the-workflow"></a>
</h2>
<p>The first step that we use on most of our <em>workflows</em> ensures
that our local project and the HPC are in sync.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_workflow_step.html">add_workflow_step</a></span><span class="op">(</span></span>
<span>  wf_summary <span class="op">=</span> <span class="va">wf</span>,</span>
<span>  step_tmpl <span class="op">=</span> <span class="fu"><a href="../reference/step_tmpl_bash_lines.html">step_tmpl_bash_lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"git pull"</span>,</span>
<span>    <span class="st">". /projects/epimodel/spack/share/spack/setup-env.sh"</span>,</span>
<span>    <span class="st">"spack load r@4.2.1"</span>,</span>
<span>    <span class="st">"Rscript -e \"renv::init(bare = TRUE)\""</span>,</span>
<span>    <span class="st">"Rscript -e \"renv::restore()\""</span></span>
<span>  <span class="op">)</span><span class="op">)</span>,</span>
<span>  sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"mem"</span> <span class="op">=</span> <span class="st">"16G"</span>,</span>
<span>    <span class="st">"cpus-per-task"</span> <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    <span class="st">"time"</span> <span class="op">=</span> <span class="fl">120</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/add_workflow_step.html">add_workflow_step()</a></code> functions takes three
arguments:</p>
<ul>
<li>
<code>wf_summary</code>: the object we made with
<code><a href="../reference/create_workflow.html">create_workflow()</a></code>, indicating onto which workflow we want
to add a step.</li>
<li>
<code>step_tmpl</code>: a <em>step template</em>, a helper function
defining what to run on the HPC (more on this latter).</li>
<li>
<code>sbatch_opts</code>: arguments to be passed to
<code>sbatch</code>. Here we specify that we want 16GB of RAM, 4 CPUs
and that the job should not take more than 120 minutes. The default
options defined in <code><a href="../reference/create_workflow.html">create_workflow()</a></code> will also be
used.</li>
</ul>
<p>The <em>step template</em> we are using here,
<code><a href="../reference/step_tmpl_bash_lines.html">step_tmpl_bash_lines()</a></code> takes a vector of <code>bash</code>
lines to be run by <code>sbatch</code> on the HPC.</p>
<p>Here we tell the step to: 1. run <code>git pull</code> 2. load our
own version of <a href="https://spack.readthedocs.io/en/latest/" class="external-link">spack</a> and load the
<code>R@4.2.1</code> module 3. ensure that <code>renv</code> is
initialized on the project (no effect if its already the case) 4. update
the packages to match the <em>renv.lock</em> file</p>
</div>
<div class="section level2">
<h2 id="running-r-code-directly">Running R Code directly<a class="anchor" aria-label="anchor" href="#running-r-code-directly"></a>
</h2>
<p>As we usually want to run <code>R</code> code and not
<code>bash</code>, slurmworkflow provides <em>step templates</em>
simplifying this process.</p>
<p>On HPCs, <code>R</code> is usually not available directly. On RSPH
HPC we use spack to manage our modules. Therefore, we store the lines
used to setup <code>R</code> on the HPC in a variable as it will be used
by all <code>R</code> <em>step templates</em>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setup_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">". /projects/epimodel/spack/share/spack/setup-env.sh"</span>,</span>
<span>  <span class="st">"spack load r@4.2.1"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="run-code-from-an-r-script">Run Code From an R Script<a class="anchor" aria-label="anchor" href="#run-code-from-an-r-script"></a>
</h3>
<p>Our next step will run the following script on the HPC.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filename: R/01-test_do_call.R</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"var1 = "</span>, <span class="va">var1</span>, <span class="st">", var2 = "</span>, <span class="va">var2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">"did_run"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="st">"did_run"</span><span class="op">)</span></span>
<span>  <span class="va">current_step</span> <span class="op">&lt;-</span> <span class="fu">slurmworkflow</span><span class="fu">::</span><span class="fu"><a href="../reference/get_current_workflow_step.html">get_current_workflow_step</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">slurmworkflow</span><span class="fu">::</span><span class="fu"><a href="../reference/change_next_workflow_step.html">change_next_workflow_step</a></span><span class="op">(</span><span class="va">current_step</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="st">"did_run"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This very simple script prints the content of <code>var1</code> and
<code>var2</code> to the standard output. Note that these variables are
never declared in the script. We will pass them as arguments to the
<em>step template</em>.</p>
<p>The second part checks for the existence of a file called “did_run”.
If it does not exist yet, it’s created and we instruct slurmworkflow to
change the <em>next step</em> to the current step. This is how you make
a loop in slurmworkflow.</p>
<p>If the file exists, which means that it’s the second time this step
is run, it removes it. In this case
<code><a href="../reference/change_next_workflow_step.html">change_next_workflow_step()</a></code> is not called and the workflow
will just continue to the next <em>step</em>.</p>
<p>Let’s now see how we add this script as a workflow step.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_workflow_step.html">add_workflow_step</a></span><span class="op">(</span></span>
<span>  wf_summary <span class="op">=</span> <span class="va">wf</span>,</span>
<span>  step_tmpl <span class="op">=</span> <span class="fu"><a href="../reference/step_tmpl_do_call_script.html">step_tmpl_do_call_script</a></span><span class="op">(</span></span>
<span>    r_script <span class="op">=</span> <span class="st">"R/01-test_do_call.R"</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="st">"ABC"</span>, var2 <span class="op">=</span> <span class="st">"DEF"</span><span class="op">)</span>,</span>
<span>    setup_lines <span class="op">=</span> <span class="va">setup_lines</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"cpus-per-task"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="st">"time"</span> <span class="op">=</span> <span class="st">"00:10:00"</span>,</span>
<span>    <span class="st">"mem"</span> <span class="op">=</span> <span class="st">"4G"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As before we use the <code><a href="../reference/add_workflow_step.html">add_workflow_step()</a></code> function. But
we change the <code>step_tmpl</code> to use
<code><a href="../reference/step_tmpl_do_call_script.html">step_tmpl_do_call_script()</a></code> with 3 arguments:</p>
<ul>
<li>
<code>r_script</code>: the path to the script to be run. Here
“R/01-test_do_call.R”. Note that this path must be valid <strong>on the
HPC</strong>.</li>
<li>
<code>args</code>: a list of variables that will be available for
the <em>step</em>. These are the <code>var1</code> and <code>var2</code>
that were missing from the script.</li>
<li>
<code>setup_lines</code>: some bash code to be run before trying to
source the script. These are the lines used to load the R module we
defined earlier.</li>
</ul>
<p>For the <code>sbatch</code> options, we ask here for 1 CPU, 4GB of
RAM and a maximum of 10 minutes.</p>
</div>
<div class="section level3">
<h3 id="iterating-over-values-in-an-r-script">Iterating Over Values in an R Script<a class="anchor" aria-label="anchor" href="#iterating-over-values-in-an-r-script"></a>
</h3>
<p>One common task on an HPC is to run the same code many time and only
vary the value of some arguments.</p>
<p>On a typical R session <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply()</a></code>, <code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map()</a></code> and
<code>Mapply()</code> are available for this purpose.</p>
<p>slurmworkflow provides the <code><a href="../reference/step_tmpl_map_script.html">step_tmpl_map_script()</a></code> to run
a script with a syntax similar to the <code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map()</a></code> function. This
create an array job where each element of input are processed in
parallel.</p>
<p>First let’s take a look at the script to be run.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filename: R/02-test_map.R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">multicore</span>, workers <span class="op">=</span> <span class="va">ncores</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">future_lapply</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"On core: "</span>, <span class="va">i</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"iterator1: "</span>, <span class="va">iterator1</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"iterator2: "</span>, <span class="va">iterator2</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"var1 = "</span>, <span class="va">var1</span>, <span class="st">", var2 = "</span>, <span class="va">var2</span>, <span class="st">"\n\n"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>This script needs 4 undeclared variables: - <code>iterator1</code>
and <code>iterator2</code>: varying values - <code>ncores</code>,
<code>var1</code> and <code>var2</code>: fixed values shared by all
replications</p>
<p>As before these values will be set by the <em>step template</em>.</p>
<p>In this script we will print in parallel the message over
<code>ncores</code>.</p>
<p>Now for the addition of the step.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cores_to_use</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_workflow_step.html">add_workflow_step</a></span><span class="op">(</span></span>
<span>  wf_summary <span class="op">=</span> <span class="va">wf</span>,</span>
<span>  step_tmpl <span class="op">=</span> <span class="fu"><a href="../reference/step_tmpl_map_script.html">step_tmpl_map_script</a></span><span class="op">(</span></span>
<span>    r_script <span class="op">=</span> <span class="st">"R/02-test_map.R"</span>,</span>
<span>    <span class="co"># arguments passed to the script</span></span>
<span>    iterator1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>    iterator2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5</span>,</span>
<span>    MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      ncores <span class="op">=</span> <span class="va">cores_to_use</span>,</span>
<span>      var1 <span class="op">=</span> <span class="st">"IJK"</span>,</span>
<span>      var2 <span class="op">=</span> <span class="st">"LMN"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    setup_lines <span class="op">=</span> <span class="va">setup_lines</span>,</span>
<span>    max_array_size <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"cpus-per-task"</span> <span class="op">=</span> <span class="va">cores_to_use</span>,</span>
<span>    <span class="st">"time"</span> <span class="op">=</span> <span class="st">"00:10:00"</span>,</span>
<span>    <span class="st">"mem-per-cpu"</span> <span class="op">=</span> <span class="st">"4G"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/step_tmpl_map_script.html">step_tmpl_map_script()</a></code> takes an
<code>r_script</code> argument similar to
<code><a href="../reference/step_tmpl_do_call_script.html">step_tmpl_do_call_script()</a></code>. The next two arguments
<code>iterator1</code> and <code>iterator2</code> will be iterated over
using <code>sbatch</code> arrays. Each replication of the job will only
have one value for each (1-6, 2-7, 3-8, 4-9 and 5-10). Similar to
<code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map()</a></code>, the <code>MoreArgs</code> argument defines variables
to be shared across replication.</p>
<p>A new argument <code>max_array_size</code> as been set to 2. This
prevents the array jobs to be of size more than 2. In our case, we have
submissions of array sizes 2, 2, and 1. In real analysis situation, the
value would be around 500. This argument prevents <a href="https://slurm.schedmd.com/" class="external-link">slurm</a> from refusing a job
submission because of the size of the array (a limit of 1000 submission
is common). <em>With EpiModel we already had cases where 30000 array
jobs were to be run. This template simply submit them in sequential
chunks of 500</em></p>
<p>In the <code>sbatch_opts</code> we specified
<code>mem-per-cpu = "4G"</code>. This means that if we change the
<code>cores_to_use</code> value, the memory asked will scale as
well.</p>
<p>To recap, this step will submit an array of 5 jobs, each receiving a
different value for <code>iterator1</code> and <code>iterator2</code>.
Each of theses jobs will run over <code>cores_to_use</code>. We use this
approach with <a href="https://github.com/EpiModel/EpiModel" class="external-link">EpiModel</a> where we run
huge arrays of jobs where each job is a set of around 30 parallel
simulations. Therefore, we here have 2 levels of parallelization. One in
<a href="https://slurm.schedmd.com/" class="external-link">slurm</a> and one in the script
itself.</p>
</div>
<div class="section level3">
<h3 id="running-an-r-function-directly">Running an R Function Directly<a class="anchor" aria-label="anchor" href="#running-an-r-function-directly"></a>
</h3>
<p>Sometimes we want to run a simple function directly without storing
it into an R script. The <code><a href="../reference/step_tmpl_do_call.html">step_tmpl_do_call()</a></code> and
<code><a href="../reference/step_tmpl_map.html">step_tmpl_map()</a></code> do exactly that for one-of functions and
<code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map()</a></code>s.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_workflow_step.html">add_workflow_step</a></span><span class="op">(</span></span>
<span>  wf_summary <span class="op">=</span> <span class="va">wf</span>,</span>
<span>  step_tmpl <span class="op">=</span> <span class="fu"><a href="../reference/step_tmpl_do_call.html">step_tmpl_do_call</a></span><span class="op">(</span></span>
<span>    what <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">var1</span>, <span class="va">var2</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"var1 = "</span>, <span class="va">var1</span>, <span class="st">", var2 = "</span>, <span class="va">var2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="st">"XYZ"</span>, var2 <span class="op">=</span> <span class="st">"UVW"</span><span class="op">)</span>,</span>
<span>    setup_lines <span class="op">=</span> <span class="va">setup_lines</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"cpus-per-task"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="st">"time"</span> <span class="op">=</span> <span class="st">"00:10:00"</span>,</span>
<span>    <span class="st">"mem"</span> <span class="op">=</span> <span class="st">"4G"</span>,</span>
<span>    <span class="st">"mail-type"</span> <span class="op">=</span> <span class="st">"END"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The syntax of these two templates is almost identical to the previous
two that we discussed. The main difference the first argument where we
pass a <code>function</code> instead of a path to a script.</p>
<p>Note: the function will be run in clean <code>R</code> session on the
HPC. All the values used by the <code>function</code> must be either
created by it, loaded by it or passed as argument.</p>
<p>Finally, as this will be our last step, we override the
<code>mail-type</code> <code>sbatch_opts</code> to receive a mail when
this <em>step</em> finishes, whatever the outcome. This way we receive a
mail telling us that the <em>workflow</em> is finished.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-the-workflow-on-an-hpc">Using the Workflow on an HPC<a class="anchor" aria-label="anchor" href="#using-the-workflow-on-an-hpc"></a>
</h2>
<p>Now that our workflow is created how to actually run the code on the
HPC?</p>
<p>We assume that we are working on a project called “test_proj”, that
this project was cloned on the HPC at the following path:
“~/projects/test_proj” and that the “~/projects/test_proj/workflows/”
directory exists.</p>
<div class="section level3">
<h3 id="sending-the-workflow-to-the-hpc">Sending the Workflow to the HPC<a class="anchor" aria-label="anchor" href="#sending-the-workflow-to-the-hpc"></a>
</h3>
<p>The following commands are to be run from your local computer.</p>
<p><strong>MacOS or GNU/Linux</strong></p>
<pre><code># bash - local
scp -r workflows/test_slurmworkflow &lt;user&gt;@clogin01.sph.emory.edu:projects/test_proj/workflows/</code></pre>
<p><strong>Windows</strong></p>
<pre><code># bash - local
set DISPLAY=
scp -r workflows\test_slurmworkflow &lt;user&gt;@clogin01.sph.emory.edu:projects/test_proj/workflows/</code></pre>
<p>Forgetting <code>set DISPLAY=</code> will prevent <code>scp</code>
from working correctly if using the RStudio terminal.</p>
<p>Note that it’s <code>workflows\networks_estimation</code>. Windows
uses back-slashes for directories and Unix OSes uses
forward-slashes.</p>
<div class="section level4">
<h4 id="running-the-workflow-from-the-hpc">Running the Workflow From the HPC<a class="anchor" aria-label="anchor" href="#running-the-workflow-from-the-hpc"></a>
</h4>
<p>For this step, you must be at the command line on the HPC. This means
that you have run: <code>ssh &lt;user&gt;@clogin01.sph.emory.edu</code>
from your local computer.</p>
<p><em>run <code>set DISPLAY=</code> on Windows before if you get this
error:
<code>ssh_askpass: posix_spawnp: No such file or directory</code></em></p>
<p>You also need to be at the root directory of the project (where the
“.git” folder is as well as the “renv.lock” file”. In this example you
would get there by running <code>cd ~/projects/test_proj</code>. The
following steps will not work if you are not at the root of your
project.</p>
<p>Running the <em>workflow</em> is done by <strong>executing</strong>
the file “workflows/estimation/start_workflow.sh” with the following
command:</p>
<pre><code><span><span class="co"># bash - hpc</span></span>
<span><span class="va">.</span><span class="op">/</span><span class="va">workflows</span><span class="op">/</span><span class="va">test_slurmworkflow</span><span class="op">/</span><span class="va">start_workflow.sh</span></span></code></pre>
<p>If you are using Windows, it may not be executable. You can solve it
with the following command:</p>
<pre><code># bash - hpc
chmod +x workflows/test_slurmworkflow/start_workflow.sh`</code></pre>
<p>The workflow will not work if you <em>source</em> the file (with
<code>source &lt;script&gt;</code> or
<code>. &lt;script&gt;</code>).</p>
<p>You can check the state of your running workflow as usual with
<code>squeue -u &lt;user&gt;</code>.</p>
<p>The logs for the workflows are in
“workflows/test_slurmworkflow/log/”.</p>
</div>
</div>
<div class="section level3">
<h3 id="the-start_workflow-sh-script">The “start_workflow.sh” Script<a class="anchor" aria-label="anchor" href="#the-start_workflow-sh-script"></a>
</h3>
<p>This start script additionally allows you to start a workflow at a
specific step with the <code>-s</code> argument.</p>
<pre><code># bash - hpc
./workflows/test_slurmworkflow/start_workflow.sh -s 3</code></pre>
<p>This will start the workflow at the 3rd step. Skipping steps 1 and
2.</p>
<p>It is sometimes desirable to start the workflow from outside of the
project it has to run on. The <code>-d</code> argument allows you to set
a different working directory for the workflow.</p>
<pre><code># bash - hpc
cd /
~/projects/test_proj/workflows/test_slurmworkflow/start_workflow.sh -d ~/projects/test_proj</code></pre>
<p>The previous block places us at the root of the file system with
<code>cd /</code>. Then we call the “start_workflow.sh” script using its
absolute path and we specify that the working directory for the workflow
must be the root of the project.</p>
<p>Remember that for <code>renv</code> to work, <code>R</code> must be
called from the directory where the “.Rprofile” file is. It’s the
directory where you can also find the “renv.lock” file.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>slurmworkflow is a very low level package providing only basic
building blocks for complex HPC computation.</p>
<p>This package is used for <a href="https://github.com/EpiModel/EpiModel" class="external-link">EpiModel</a> applied
projects through higher level functions in <a href="https://github.com/EpiModel/EpiModelHPC/blob/main/vignettes/epimodelhiv-slurmworkflow.Rmd" class="external-link">EpiModelHPC</a>
and <a href="https://github.com/EpiModel/swfcalib" class="external-link">swfcalib</a>, an
automated calibration system used for our models (WIP).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Adrien Le Guillou.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
